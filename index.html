<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- FIX: Add cache control meta tags to prevent browser caching issues -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>ระบบบันทึกการลา - กลุ่มงานทันตกรรม โรงพยาบาลบำเหน็จณรงค์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = 'https://nekghcpcuqsrxetiqvmn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2doY3BjdXFzcnhldGlxdm1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzA0ODAsImV4cCI6MjA3MDI0NjQ4MH0.343Oimw3xQNF81k0QTijupa4Wzs0kbTYffxjhL12DMY';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Service Worker Cleanup ---
        window.onload = () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister().then(success => {
                            if (success) console.log('Service Worker unregistered successfully.');
                        });
                    }
                }).catch(function(err) {
                    console.warn('Service Worker unregistration check failed: ', err); 
                });
            }
        };

        let currentUserProfile = null;
        let editingStaffId = null;
        let allStaffData = []; // Cache for all staff data
        let calendarDate = new Date();

        // --- AUTH & LINKING FUNCTIONS ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                showToast(`Login ไม่สำเร็จ: ${error.message}`, 'error');
            } else {
                 e.target.reset();
            }
        }
        
        async function handleAccountLink(e) {
            e.preventDefault();
            const staffCode = document.getElementById('staff-code-input').value;
            if (!staffCode) {
                showToast('กรุณากรอกรหัสเจ้าหน้าที่', 'error');
                return;
            }
            
            setLoading(true);
            try {
                const { data, error } = await supabase.rpc('link_account_with_staff_code', {
                    input_staff_code: staffCode
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (data && data.error) {
                    throw new Error(data.error);
                }
                
                showToast('เชื่อมบัญชีสำเร็จ! กำลังรีโหลด...', 'success');
                setTimeout(() => window.location.reload(), 2000);

            } catch (error) {
                console.error('Linking error:', error.message);
                showToast(`เชื่อมบัญชีไม่สำเร็จ: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Error signing out:', error);
                    showToast('เกิดข้อผิดพลาดในการออกจากระบบ: ' + error.message, 'error');
                }
            } catch (e) {
                console.error('Exception during logout:', e);
                showToast('เกิดข้อผิดพลาดร้ายแรงระหว่างการออกจากระบบ', 'error');
            } finally {
                currentUserProfile = null;
                allStaffData = [];
                showView('auth-section');
                setTimeout(() => window.location.reload(true), 100);
            }
        }

        // --- UI FUNCTIONS ---
        function showView(viewId) {
            ['auth-section', 'link-account-section', 'app-section', 'admin-dashboard-section', 'admin-report-section', 'calendar-section'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function setLoading(isLoading) {
            document.getElementById('link-account-btn').disabled = isLoading;
            document.getElementById('link-account-btn-text').textContent = isLoading ? 'กำลังตรวจสอบ...' : 'ยืนยันและเชื่อมบัญชี';
        }

        async function initializeAppView() {
            document.getElementById('user-display').textContent = `สวัสดี, ${currentUserProfile.name}`;
            const isAdmin = currentUserProfile.is_admin;
            document.getElementById('manage-staff-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-dashboard-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-report-btn').classList.toggle('hidden', !isAdmin);


            populateFiscalYearSelector(document.getElementById('fiscal-year-selector'));
            await loadStaff();

            if (!isAdmin) {
                document.getElementById('staff-selector').value = currentUserProfile.id;
                document.getElementById('staff-selector').dispatchEvent(new Event('change'));
                document.getElementById('staff-selector').disabled = true;
            }

            showView('app-section');
        }

        // --- MAIN LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // Listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('link-account-form').addEventListener('submit', handleAccountLink);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('yearly-summary').addEventListener('click', handleLeaveListClick);
            document.getElementById('close-edit-leave-modal-btn').addEventListener('click', closeEditLeaveModal);
            document.getElementById('edit-leave-form').addEventListener('submit', handleUpdateLeaveRecord);
            document.getElementById('admin-dashboard-btn').addEventListener('click', showAdminDashboard);
            document.getElementById('admin-report-btn').addEventListener('click', showReportView);
            document.getElementById('back-to-app-btn').addEventListener('click', () => showView('app-section'));
            document.getElementById('back-to-app-btn-report').addEventListener('click', () => showView('app-section'));
            document.getElementById('generate-report-btn').addEventListener('click', generateYearlyReport);
            document.getElementById('calendar-view-btn').addEventListener('click', showCalendarView);
            document.getElementById('back-to-app-btn-calendar').addEventListener('click', () => showView('app-section'));
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar(calendarDate);
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar(calendarDate);
            });

            // More robust auth state handler
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_OUT' || !session) {
                    currentUserProfile = null;
                    showView('auth-section');
                    return;
                }
                if (session && session.user) {
                    try {
                        const { data: profileData, error: profileError } = await supabase.rpc('get_my_profile');
                        if (profileError) throw profileError;
                        const userProfile = profileData && profileData.length > 0 ? profileData[0] : null;
                        if (userProfile) {
                            currentUserProfile = userProfile;
                            initializeAppView();
                        } else {
                            showView('link-account-section');
                        }
                    } catch (error) {
                        console.error("Critical error during auth state change:", error);
                        showToast('เกิดข้อผิดพลาดร้ายแรง โปรดลองอีกครั้ง', 'error');
                        await handleLogout();
                    }
                }
            });

            document.getElementById('staff-selector').addEventListener('change', (e) => {
                const staffId = e.target.value;
                document.getElementById('staff-details-section').classList.toggle('hidden', !staffId);
                if (staffId) loadLeaveDataForStaff(staffId);
            });
            
            document.getElementById('fiscal-year-selector').addEventListener('change', () => {
                const staffId = document.getElementById('staff-selector').value;
                if (staffId) {
                    loadLeaveDataForStaff(staffId);
                }
            });

            document.getElementById('leave-form').addEventListener('submit', addLeaveRecord);
            document.getElementById('manage-staff-btn').addEventListener('click', openStaffModal);
            document.getElementById('close-modal-btn').addEventListener('click', closeStaffModal);
            document.getElementById('staff-modal-overlay').addEventListener('click', closeStaffModal);
            document.getElementById('staff-form').addEventListener('submit', handleStaffFormSubmit);
            document.getElementById('staff-list').addEventListener('click', handleStaffListClick);
        });
        
        // --- DATA & UI FUNCTIONS ---

        async function loadStaff() {
            const { data, error } = await supabase.from('staff').select('*').order('name');
            if (error) {
                showToast('ไม่สามารถดึงข้อมูลบุคลากรได้: ' + error.message, 'error');
                return;
            }
            allStaffData = data; // Cache data

            const staffSelector = document.getElementById('staff-selector');
            const staffList = document.getElementById('staff-list');
            const currentSelectedId = staffSelector.value;

            staffSelector.innerHTML = '<option value="">-- เลือกบุคลากร --</option>';
            staffList.innerHTML = '';

            const groupOrder = ['ทันตแพทย์', 'ทันตาภิบาล', 'พนักงานบริการ', 'พนักงานช่วยเหลือคนไข้'];
            
            const groupedStaff = data.reduce((acc, staff) => {
                const type = staff.staff_type || 'อื่น ๆ';
                if (!acc[type]) acc[type] = [];
                acc[type].push(staff);
                return acc;
            }, {});

            const renderGroup = (groupName) => {
                if (!groupedStaff[groupName]) return;
                const optgroup = document.createElement('optgroup');
                optgroup.label = groupName;
                groupedStaff[groupName].forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = staff.name;
                    optgroup.appendChild(option);
                });
                staffSelector.appendChild(optgroup);

                const header = document.createElement('div');
                header.className = 'p-2 bg-gray-200 font-bold text-gray-700 mt-4 first:mt-0';
                header.textContent = groupName;
                staffList.appendChild(header);

                groupedStaff[groupName].forEach(staff => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-3 md:grid-cols-4 gap-2 items-center p-2 border-b';
                    div.innerHTML = `
                        <div class="col-span-2 md:col-span-3">
                            <p class="font-semibold">${staff.name}</p>
                             <p class="text-sm text-gray-600">${staff.is_admin ? '<span class="text-red-500 font-bold">Admin</span>' : 'User'}</p>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="edit-btn p-2 text-blue-600 hover:text-blue-800" data-id="${staff.id}" data-name="${staff.name}" data-staff_type="${staff.staff_type || ''}" data-is_admin="${staff.is_admin}" data-staff_code="${staff.staff_code || ''}">แก้ไข</button>
                            <button class="delete-btn p-2 text-red-600 hover:text-red-800" data-id="${staff.id}" data-name="${staff.name}">ลบ</button>
                        </div>
                    `;
                    staffList.appendChild(div);
                });
            };
            
            groupOrder.forEach(groupName => renderGroup(groupName));
            
            Object.keys(groupedStaff).forEach(groupName => {
                if (!groupOrder.includes(groupName)) renderGroup(groupName);
            });

            staffSelector.value = currentSelectedId;
        }
        
        function openStaffModal() { document.getElementById('staff-modal').classList.remove('hidden'); }
        function closeStaffModal() {
            document.getElementById('staff-modal').classList.add('hidden');
            document.getElementById('staff-form').reset();
            document.getElementById('form-title').textContent = 'เพิ่มบุคลากรใหม่';
            document.getElementById('staff-submit-btn').textContent = 'เพิ่มบุคลากร';
            editingStaffId = null;
        }

        async function handleStaffFormSubmit(e) {
            e.preventDefault();
            const staffData = {
                name: document.getElementById('staff-name').value,
                staff_type: document.getElementById('staff-type').value,
                is_admin: document.getElementById('staff-is-admin').checked,
                staff_code: document.getElementById('staff-code').value
            };

            let error;

            if (editingStaffId) {
                const { error: updateError } = await supabase.from('staff').update(staffData).eq('id', editingStaffId);
                error = updateError;
            } else {
                const { error: insertError } = await supabase.from('staff').insert([staffData]);
                error = insertError;
            }
            if (error) {
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } else {
                showToast('บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                closeStaffModal(); await loadStaff();
            }
        }
        
        function handleStaffListClick(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const name = target.dataset.name;

            if (target.classList.contains('edit-btn')) {
                document.getElementById('form-title').textContent = `แก้ไขข้อมูล: ${name}`;
                document.getElementById('staff-name').value = name;
                document.getElementById('staff-type').value = target.dataset.staff_type;
                document.getElementById('staff-is-admin').checked = target.dataset.is_admin === 'true';
                document.getElementById('staff-code').value = target.dataset.staff_code;
                document.getElementById('staff-submit-btn').textContent = 'บันทึกการเปลี่ยนแปลง';
                editingStaffId = id;
            }
            
            if (target.classList.contains('delete-btn')) {
                 if (confirm(`คุณต้องการลบบุคลากร "${name}" ใช่หรือไม่?`)) {
                    deleteStaff(id, name);
                 }
            }
        }
        
        async function deleteStaff(id, name) {
            const { error } = await supabase.from('staff').delete().eq('id', id);
            if (error) { showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error'); } 
            else { showToast(`ลบ ${name} ออกแล้ว`, 'success'); await loadStaff(); }
        }
        
        async function addLeaveRecord(e) {
             e.preventDefault();
            const staffId = document.getElementById('staff-selector').value;
            const daysTaken = parseFloat(document.getElementById('days-taken').value);
            const leaveType = document.getElementById('leave-type').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const reason = document.getElementById('reason').value;
            if (!staffId || !leaveType || !startDate || !endDate || isNaN(daysTaken)) {
                showToast('กรุณากรอกข้อมูลการลาให้ครบถ้วน', 'error'); return;
            }
            const { error } = await supabase.from('leave_records').insert([{ staff_id: staffId, leave_type: leaveType, start_date: startDate, end_date: endDate, days_taken: daysTaken, reason: reason }]);
            if (error) { showToast('เกิดข้อผิดพลาด: ' + error.message, 'error'); } 
            else { showToast('บันทึกข้อมูลการลาเรียบร้อยแล้ว', 'success'); document.getElementById('leave-form').reset(); await loadLeaveDataForStaff(staffId); }
        }
        
        function showToast(message, type = 'success') { const toast = document.getElementById('toast-notification');const toastMessage = document.getElementById('toast-message');toast.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300';if (type === 'success') {toast.classList.add('bg-green-500');} else {toast.classList.add('bg-red-500');}toastMessage.textContent = message;toast.style.transform = 'translateY(0)';toast.style.opacity = '1';setTimeout(() => {toast.style.transform = 'translateY(-20px)';toast.style.opacity = '0';}, 3000);}
        
        function getCurrentFiscalYearBE() {
            const today = new Date();
            const currentYearCE = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11
            if (currentMonth >= 9) { // ตุลาคม - ธันวาคม
                return currentYearCE + 543 + 1;
            } else { // มกราคม - กันยายน
                return currentYearCE + 543;
            }
        }
        
        function populateFiscalYearSelector(selectorElement) {
            selectorElement.innerHTML = '';
            const currentFiscalYear = getCurrentFiscalYearBE();
            const startYear = 2568; 
            for (let i = currentFiscalYear + 2; i >= startYear; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                selectorElement.appendChild(option);
            }
            selectorElement.value = currentFiscalYear;
        }
        
        function getFiscalYearRange(fiscalYearBE) { 
            if (!fiscalYearBE) { fiscalYearBE = getCurrentFiscalYearBE(); }
            const startYearCE = fiscalYearBE - 544; 
            return { startDate: `${startYearCE}-10-01`, endDate: `${startYearCE + 1}-09-30` };
        }

        async function loadLeaveDataForStaff(staffId) { 
            const selectedFiscalYear = parseInt(document.getElementById('fiscal-year-selector').value);
            const { startDate, endDate } = getFiscalYearRange(selectedFiscalYear);

            const { data: fiscalData, error: fiscalError } = await supabase
                .from('staff_fiscal_year_data')
                .select('accumulated_vacation')
                .eq('staff_id', staffId)
                .eq('fiscal_year_be', selectedFiscalYear)
                .single();

            const accumulatedVacation = fiscalError ? 0 : fiscalData.accumulated_vacation;
            
            const { data: leaveRecords, error } = await supabase.from('leave_records').select('*').eq('staff_id', staffId).gte('start_date', startDate).lte('start_date', endDate); 
            if (error) { showToast('ไม่สามารถดึงข้อมูลการลาได้', 'error'); return; } 
            
            const vacationTaken = leaveRecords.filter(r => r.leave_type === 'vacation').reduce((sum, r) => sum + r.days_taken, 0); 
            const personalTaken = leaveRecords.filter(r => r.leave_type === 'personal').reduce((sum, r) => sum + r.days_taken, 0); 
            const sickTaken = leaveRecords.filter(r => r.leave_type === 'sick').reduce((sum, r) => sum + r.days_taken, 0); 
            
            document.getElementById('accumulated-vacation').textContent = accumulatedVacation; 
            document.getElementById('vacation-taken').textContent = vacationTaken; 
            document.getElementById('vacation-remaining').textContent = accumulatedVacation - vacationTaken; 
            document.getElementById('personal-taken').textContent = personalTaken; 
            document.getElementById('sick-taken').textContent = sickTaken; 
            renderMonthlySummary(leaveRecords); 
            renderYearlySummary(leaveRecords); 
        }
        function renderMonthlySummary(records) { const monthlySummaryEl = document.getElementById('monthly-summary'); monthlySummaryEl.innerHTML = ''; const recordsByMonth = {}; const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"]; records.forEach(record => { const d = new Date(record.start_date); const key = `${d.getFullYear()}-${d.getMonth()}`; if (!recordsByMonth[key]) { recordsByMonth[key] = { monthName: `${monthNames[d.getMonth()]} ${d.getFullYear() + 543}`, vacation: 0, personal: 0, sick: 0 }; } recordsByMonth[key][record.leave_type] += record.days_taken; }); if (Object.keys(recordsByMonth).length === 0) { monthlySummaryEl.innerHTML = '<p class="text-gray-500">ยังไม่มีข้อมูล</p>'; return; } monthlySummaryEl.innerHTML = `<table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="p-2 text-left">เดือน</th><th class="p-2">พักผ่อน</th><th class="p-2">กิจ</th><th class="p-2">ป่วย</th></tr></thead><tbody>${Object.values(recordsByMonth).map(m => `<tr><td class="p-2 border-b">${m.monthName}</td><td class="p-2 border-b text-center">${m.vacation}</td><td class="p-2 border-b text-center">${m.personal}</td><td class="p-2 border-b text-center">${m.sick}</td></tr>`).join('')}</tbody></table>`; }
        
        function renderYearlySummary(records) { 
            const yearlySummaryEl = document.getElementById('yearly-summary'); 
            yearlySummaryEl.innerHTML = ''; 
            if(records.length === 0) { 
                yearlySummaryEl.innerHTML = '<p class="text-gray-500">ยังไม่มีข้อมูล</p>'; 
                return; 
            } 
            const typeMap = { 'vacation': 'ลาพักผ่อน', 'personal': 'ลากิจ', 'sick': 'ลาป่วย' }; 
            yearlySummaryEl.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 text-left">วันที่</th>
                            <th class="p-2 text-left">ประเภท</th>
                            <th class="p-2">จำนวนวัน</th>
                            <th class="p-2 text-left">เหตุผล</th>
                            <th class="p-2 text-left">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.sort((a,b) => new Date(b.start_date) - new Date(a.start_date)).map(r => `
                            <tr>
                                <td class="p-2 border-b">${new Date(r.start_date).toLocaleDateString('th-TH')}</td>
                                <td class="p-2 border-b">${typeMap[r.leave_type]}</td>
                                <td class="p-2 border-b text-center">${r.days_taken}</td>
                                <td class="p-2 border-b">${r.reason || '-'}</td>
                                <td class="p-2 border-b">
                                    <button class="edit-leave-btn text-blue-600 hover:underline text-sm" data-record='${JSON.stringify(r)}'>แก้ไข</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`; 
        }

        // --- EDIT/DELETE LEAVE FUNCTIONS ---
        function openEditLeaveModal(record) {
            document.getElementById('edit-leave-id').value = record.id;
            document.getElementById('edit-leave-type').value = record.leave_type;
            document.getElementById('edit-start-date').value = record.start_date;
            document.getElementById('edit-end-date').value = record.end_date;
            document.getElementById('edit-days-taken').value = record.days_taken;
            document.getElementById('edit-reason').value = record.reason || '';
            document.getElementById('edit-leave-modal').classList.remove('hidden');
        }

        function closeEditLeaveModal() {
            document.getElementById('edit-leave-modal').classList.add('hidden');
            document.getElementById('edit-leave-form').reset();
        }

        async function handleUpdateLeaveRecord(e) {
            e.preventDefault();
            const id = document.getElementById('edit-leave-id').value;
            const updatedData = {
                leave_type: document.getElementById('edit-leave-type').value,
                start_date: document.getElementById('edit-start-date').value,
                end_date: document.getElementById('edit-end-date').value,
                days_taken: parseFloat(document.getElementById('edit-days-taken').value),
                reason: document.getElementById('edit-reason').value
            };

            const { error } = await supabase.from('leave_records').update(updatedData).eq('id', id);

            if (error) {
                showToast(`เกิดข้อผิดพลาดในการอัปเดต: ${error.message}`, 'error');
            } else {
                showToast('อัปเดตข้อมูลการลาเรียบร้อยแล้ว', 'success');
                closeEditLeaveModal();
                const staffId = document.getElementById('staff-selector').value;
                await loadLeaveDataForStaff(staffId);
            }
        }

        function handleLeaveListClick(e) {
            const target = e.target;
            if (target.classList.contains('edit-leave-btn')) {
                const record = JSON.parse(target.dataset.record);
                openEditLeaveModal(record);
            }
        }

        // --- ADMIN DASHBOARD FUNCTIONS ---
        function showAdminDashboard() {
            renderAdminUserList();
            showView('admin-dashboard-section');
        }

        function renderAdminUserList() {
            const listEl = document.getElementById('admin-user-list');
            listEl.innerHTML = '';
            allStaffData.forEach(staff => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 border-b bg-white rounded-lg shadow-sm';
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-lg">${staff.name}</p>
                        <p class="text-gray-600">${staff.staff_type}</p>
                    </div>
                    <button class="manage-user-btn bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600" data-id="${staff.id}">จัดการ</button>
                `;
                listEl.appendChild(div);
            });
        }
        
        document.getElementById('admin-user-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('manage-user-btn')) {
                const staffId = e.target.dataset.id;
                await openAdminEditUser(staffId);
            }
        });

        async function openAdminEditUser(staffId) {
            const staff = allStaffData.find(s => s.id === staffId);
            if (!staff) {
                showToast('ไม่พบข้อมูลบุคลากร', 'error');
                return;
            }
            
            document.getElementById('admin-edit-name').textContent = staff.name;
            document.getElementById('admin-edit-staff-id').value = staff.id;
            document.getElementById('admin-edit-staff-name').value = staff.name;
            document.getElementById('admin-edit-staff-type').value = staff.staff_type;

            const { data, error } = await supabase
                .from('staff_fiscal_year_data')
                .select('*')
                .eq('staff_id', staffId)
                .order('fiscal_year_be', { ascending: false });

            if (error) {
                showToast('ไม่สามารถดึงข้อมูลวันลาสะสมได้', 'error');
                return;
            }

            const fiscalList = document.getElementById('admin-fiscal-list');
            fiscalList.innerHTML = '';
            
            // Add current and next fiscal year if they don't exist
            const currentFiscalYear = getCurrentFiscalYearBE();
            const yearsToDisplay = new Set(data.map(d => d.fiscal_year_be));
            yearsToDisplay.add(currentFiscalYear);
            yearsToDisplay.add(currentFiscalYear + 1);

            const sortedYears = Array.from(yearsToDisplay).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                const record = data.find(d => d.fiscal_year_be === year);
                const days = record ? record.accumulated_vacation : 0;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-100 rounded';
                div.innerHTML = `
                    <label for="year-${year}" class="font-medium">ปีงบประมาณ ${year}:</label>
                    <div class="flex items-center gap-2">
                         <input type="number" step="0.5" id="year-${year}" value="${days}" class="w-24 p-1 border rounded-md text-center">
                         <button class="save-fiscal-btn bg-green-500 text-white text-sm py-1 px-2 rounded hover:bg-green-600" data-year="${year}">บันทึก</button>
                    </div>
                `;
                fiscalList.appendChild(div);
            });
            
            document.getElementById('admin-dashboard-list-view').classList.add('hidden');
            document.getElementById('admin-dashboard-edit-view').classList.remove('hidden');
        }

        document.getElementById('back-to-list-btn').addEventListener('click', () => {
             document.getElementById('admin-dashboard-edit-view').classList.add('hidden');
             document.getElementById('admin-dashboard-list-view').classList.remove('hidden');
        });

        document.getElementById('admin-fiscal-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('save-fiscal-btn')) {
                const staffId = document.getElementById('admin-edit-staff-id').value;
                const year = parseInt(e.target.dataset.year);
                const daysInput = document.getElementById(`year-${year}`);
                const days = parseFloat(daysInput.value);

                if(isNaN(days) || days < 0) {
                    showToast('กรุณาใส่จำนวนวันที่ถูกต้อง', 'error');
                    return;
                }

                const { error } = await supabase.rpc('upsert_accumulated_vacation', { 
                    p_staff_id: staffId, 
                    p_fiscal_year_be: year, 
                    p_new_days: days
                });

                if (error) {
                    showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
                } else {
                    showToast(`บันทึกวันลาปี ${year} เรียบร้อยแล้ว`, 'success');
                }
            }
        });

        document.getElementById('admin-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const staffId = document.getElementById('admin-edit-staff-id').value;
            const updatedData = {
                name: document.getElementById('admin-edit-staff-name').value,
                staff_type: document.getElementById('admin-edit-staff-type').value
            };
            const { error } = await supabase.from('staff').update(updatedData).eq('id', staffId);
            if (error) {
                showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
            } else {
                showToast('อัปเดตข้อมูลบุคลากรเรียบร้อยแล้ว', 'success');
                await loadStaff(); // Refresh staff cache
                renderAdminUserList(); // Re-render the list with new data
            }
        });
        
        // --- ADMIN REPORT FUNCTIONS ---
        function showReportView() {
            populateFiscalYearSelector(document.getElementById('admin-report-fiscal-year-selector'));
            document.getElementById('report-results-container').innerHTML = ''; // Clear previous report
            showView('admin-report-section');
        }

        async function generateYearlyReport() {
            const reportBtn = document.getElementById('generate-report-btn');
            const container = document.getElementById('report-results-container');
            
            reportBtn.disabled = true;
            reportBtn.textContent = 'กำลังสร้างรายงาน...';
            container.innerHTML = '<p class="text-center text-gray-500">กำลังดึงข้อมูล...</p>';

            try {
                const selectedYear = parseInt(document.getElementById('admin-report-fiscal-year-selector').value);
                const { startDate, endDate } = getFiscalYearRange(selectedYear);

                // Fetch all necessary data in parallel
                const [fiscalDataRes, leaveRecordsRes] = await Promise.all([
                    supabase.from('staff_fiscal_year_data').select('*').eq('fiscal_year_be', selectedYear),
                    supabase.from('leave_records').select('*').gte('start_date', startDate).lte('start_date', endDate)
                ]);

                if (fiscalDataRes.error) throw fiscalDataRes.error;
                if (leaveRecordsRes.error) throw leaveRecordsRes.error;

                const fiscalData = fiscalDataRes.data;
                const leaveRecords = leaveRecordsRes.data;

                let reportData = allStaffData.map(staff => {
                    const staffFiscal = fiscalData.find(f => f.staff_id === staff.id);
                    const accumulated = staffFiscal ? staffFiscal.accumulated_vacation : 0;

                    const staffLeaves = leaveRecords.filter(l => l.staff_id === staff.id);
                    const vacation = staffLeaves.filter(l => l.leave_type === 'vacation').reduce((sum, r) => sum + r.days_taken, 0);
                    const personal = staffLeaves.filter(l => l.leave_type === 'personal').reduce((sum, r) => sum + r.days_taken, 0);
                    const sick = staffLeaves.filter(l => l.leave_type === 'sick').reduce((sum, r) => sum + r.days_taken, 0);
                    
                    return {
                        name: staff.name,
                        staff_type: staff.staff_type,
                        accumulated: accumulated,
                        vacationTaken: vacation,
                        vacationRemaining: accumulated - vacation,
                        personalTaken: personal,
                        sickTaken: sick
                    };
                });
                
                // Sort the report data by the specified staff type order
                const groupOrder = ['ทันตแพทย์', 'ทันตาภิบาล', 'พนักงานบริการ', 'พนักงานช่วยเหลือคนไข้'];
                reportData.sort((a, b) => {
                    const indexA = groupOrder.indexOf(a.staff_type);
                    const indexB = groupOrder.indexOf(b.staff_type);

                    const finalIndexA = indexA === -1 ? Infinity : indexA;
                    const finalIndexB = indexB === -1 ? Infinity : indexB;

                    if (finalIndexA !== finalIndexB) {
                        return finalIndexA - finalIndexB;
                    }
                    
                    return a.name.localeCompare(b.name, 'th');
                });

                renderReportTable(reportData, selectedYear);

            } catch (error) {
                console.error('Report generation error:', error);
                container.innerHTML = `<p class="text-center text-red-500">เกิดข้อผิดพลาด: ${error.message}</p>`;
                showToast('ไม่สามารถสร้างรายงานได้', 'error');
            } finally {
                reportBtn.disabled = false;
                reportBtn.textContent = 'สร้างรายงาน';
            }
        }

        function renderReportTable(data, year) {
            const container = document.getElementById('report-results-container');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่พบข้อมูลสำหรับปีที่เลือก</p>';
                return;
            }

            const tableRows = data.map(row => `
                <tr class="border-b">
                    <td class="p-3">${row.name}</td>
                    <td class="p-3">${row.staff_type}</td>
                    <td class="p-3 text-center">${row.accumulated}</td>
                    <td class="p-3 text-center text-yellow-600">${row.vacationTaken}</td>
                    <td class="p-3 text-center font-bold ${row.vacationRemaining < 0 ? 'text-red-500' : 'text-green-600'}">${row.vacationRemaining}</td>
                    <td class="p-3 text-center text-purple-600">${row.personalTaken}</td>
                    <td class="p-3 text-center text-red-600">${row.sickTaken}</td>
                </tr>
            `).join('');

            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4">รายงานสรุปวันลา ประจำปีงบประมาณ ${year}</h3>
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3 text-left">ชื่อ-สกุล</th>
                                <th class="p-3 text-left">ตำแหน่ง</th>
                                <th class="p-3">พักผ่อนสะสม</th>
                                <th class="p-3">พักผ่อนใช้ไป</th>
                                <th class="p-3">พักผ่อนคงเหลือ</th>
                                <th class="p-3">ลากิจ</th>
                                <th class="p-3">ลาป่วย</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- CALENDAR FUNCTIONS ---
        function showCalendarView() {
            calendarDate = new Date(); // Reset to current month
            renderCalendar(calendarDate);
            showView('calendar-section');
        }

        async function renderCalendar(date) {
            const grid = document.getElementById('calendar-grid');
            const header = document.getElementById('month-year-header');
            grid.innerHTML = '<div class="col-span-7 text-center p-8">กำลังโหลด...</div>';

            const year = date.getFullYear();
            const month = date.getMonth(); // 0-11

            header.textContent = `${date.toLocaleDateString('th-TH', { month: 'long' })} ${year + 543}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon...

            // Fetch leave records for this month
            const monthStartDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const monthEndDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            // FIX: Correct query to fetch records that OVERLAP with the current month, not just start in it.
            const { data: leaveRecords, error } = await supabase.from('leave_records')
                .select('*')
                .lte('start_date', monthEndDate) // Leave starts on or before the end of the month
                .gte('end_date', monthStartDate);  // Leave ends on or after the start of the month

            if (error) {
                showToast('ไม่สามารถดึงข้อมูลปฏิทินได้', 'error');
                grid.innerHTML = '<div class="col-span-7 text-center text-red-500 p-8">เกิดข้อผิดพลาด</div>';
                return;
            }

            grid.innerHTML = ''; // Clear loading message

            // Day headers
            ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'text-center font-bold text-gray-600 py-2';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            });

            // Blank days before the 1st
            for (let i = 0; i < startDayOfWeek; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Calendar days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'border rounded-md p-2 h-28 flex flex-col';
                
                const dayNumber = document.createElement('span');
                dayNumber.textContent = day;
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                     dayNumber.className = 'bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center';
                } else {
                     dayNumber.className = 'font-semibold';
                }
                dayEl.appendChild(dayNumber);

                const leavesOnThisDay = document.createElement('div');
                leavesOnThisDay.className = 'mt-1 text-xs overflow-y-auto';
                
                const currentDate = new Date(year, month, day);

                leaveRecords.forEach(record => {
                    const startDate = new Date(record.start_date + 'T00:00:00');
                    const endDate = new Date(record.end_date + 'T00:00:00');

                    if (currentDate >= startDate && currentDate <= endDate) {
                        const staff = allStaffData.find(s => s.id === record.staff_id);
                        if (staff) {
                            const leaveEntry = document.createElement('div');
                            let bgColor = 'bg-gray-200';
                            let leaveTypeName = 'ลา';
                            if (record.leave_type === 'vacation') {
                                bgColor = 'bg-blue-100 text-blue-800';
                                leaveTypeName = 'พักผ่อน';
                            }
                            if (record.leave_type === 'personal') {
                                bgColor = 'bg-purple-100 text-purple-800';
                                leaveTypeName = 'กิจ';
                            }
                            if (record.leave_type === 'sick') {
                                bgColor = 'bg-red-100 text-red-800';
                                leaveTypeName = 'ป่วย';
                            }
                            
                            leaveEntry.className = `${bgColor} p-1 rounded mb-1 truncate`;
                            leaveEntry.textContent = `${staff.name.split(' ')[0]} (${leaveTypeName})`;
                            leaveEntry.title = `${staff.name} (${leaveTypeName})`;
                            leavesOnThisDay.appendChild(leaveEntry);
                        }
                    }
                });
                dayEl.appendChild(leavesOnThisDay);
                grid.appendChild(dayEl);
            }
        }

    </script>
    <style> body { font-family: 'Sarabun', sans-serif; background-color: #f7fafc; } .summary-card { background-color: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); } .tab-button { color: #6b7280; border-bottom: 2px solid transparent; padding-bottom: 0.5rem; } .tab-button.active { border-color: #4f46e5; color: #4f46e5; font-weight: 600; } </style>
</head>
<body>
    <div id="toast-notification" style="opacity:0; transform: translateY(-20px); z-index: 9999;" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md"><h2 class="text-2xl font-bold text-center text-gray-800">เข้าสู่ระบบบันทึกการลา</h2><form id="login-form" class="space-y-6"><div><label for="email" class="block text-sm font-medium text-gray-700">อีเมล</label><input type="email" name="email" id="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div><div><label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label><input type="password" name="password" id="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div><button type="submit" class="w-full py-2 px-4 text-white bg-indigo-600 rounded-md hover:bg-indigo-700">เข้าสู่ระบบ</button></form></div>
    </div>
    
    <!-- Account Linking Section -->
    <div id="link-account-section" class="hidden flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-800">เชื่อมบัญชีของคุณ</h2>
            <p class="text-center text-gray-600">กรุณากรอกรหัสเจ้าหน้าที่ เพื่อเชื่อมต่อบัญชีผู้ใช้งานของคุณกับข้อมูลบุคลากรในระบบ</p>
            <form id="link-account-form" class="space-y-6">
                <div>
                    <label for="staff-code-input" class="block text-sm font-medium text-gray-700">รหัสเจ้าหน้าที่</label>
                    <input type="text" name="staff_code" id="staff-code-input" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="link-account-btn" type="submit" class="w-full py-2 px-4 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 flex justify-center items-center">
                    <span id="link-account-btn-text">ยืนยันและเชื่อมบัญชี</span>
                </button>
            </form>
        </div>
    </div>

    <!-- App Section -->
    <div id="app-section" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ระบบบันทึกการลา</h1>
                <p class="text-lg text-gray-600">กลุ่มงานทันตกรรม โรงพยาบาลบำเหน็จณรงค์</p>
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                 <button id="calendar-view-btn" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">ปฏิทินวันลา</button>
                 <button id="admin-report-btn" class="hidden bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700">รายงานสรุป</button>
                 <button id="admin-dashboard-btn" class="hidden bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">แผงควบคุม</button>
                 <div class="text-right">
                    <p id="user-display" class="text-gray-700"></p>
                    <button id="logout-btn" class="text-sm text-indigo-600 hover:underline">ออกจากระบบ</button>
                </div>
            </div>
        </header>
        <div class="max-w-xl mx-auto mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="sm:col-span-2"><label for="staff-selector" class="block text-sm font-medium text-gray-700 mb-1">เลือกบุคลากร:</label><select id="staff-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select></div>
            <div class="self-end"><button id="manage-staff-btn" class="hidden w-full bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-800">จัดการบุคลากร</button></div>
        </div>
        <div id="staff-details-section" class="hidden">
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">สรุปภาพรวม</h2>
                    <div class="mt-2 sm:mt-0">
                        <label for="fiscal-year-selector" class="text-sm font-medium text-gray-700 mr-2">เลือกปีงบประมาณ:</label>
                        <select id="fiscal-year-selector" class="p-2 border border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div class="summary-card text-center text-blue-600">
                        <p class="text-sm text-gray-500">พักผ่อนสะสม</p>
                        <p id="accumulated-vacation" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="summary-card text-center text-yellow-600"><p class="text-sm text-gray-500">ใช้ไป</p><p id="vacation-taken" class="text-4xl font-bold">0</p></div>
                    <div class="summary-card text-center text-green-600"><p class="text-sm text-gray-500">คงเหลือ</p><p id="vacation-remaining" class="text-4xl font-bold">0</p></div>
                    <div class="summary-card text-center text-purple-600"><p class="text-sm text-gray-500">ลากิจ</p><p id="personal-taken" class="text-4xl font-bold">0</p></div>
                    <div class="summary-card text-center text-red-600"><p class="text-sm text-gray-500">ลาป่วย</p><p id="sick-taken" class="text-4xl font-bold">0</p></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8"><h2 class="text-2xl font-semibold text-gray-700 mb-4">บันทึกการลา</h2><form id="leave-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div><label for="leave-type">ประเภท</label><select id="leave-type" required class="mt-1 block w-full p-2 border rounded-md"><option value="vacation">พักผ่อน</option><option value="personal">กิจ</option><option value="sick">ป่วย</option></select></div><div><label for="start-date">วันที่เริ่ม</label><input type="date" id="start-date" required class="mt-1 block w-full p-2 border rounded-md"></div><div><label for="end-date">วันที่สิ้นสุด</label><input type="date" id="end-date" required class="mt-1 block w-full p-2 border rounded-md"></div><div><label for="days-taken">จำนวนวัน</label><input type="number" step="0.5" id="days-taken" required class="mt-1 block w-full p-2 border rounded-md"></div><div class="md:col-span-2 lg:col-span-3"><label for="reason">เหตุผล</label><input type="text" id="reason" class="mt-1 block w-full p-2 border rounded-md"></div><div><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md">บันทึก</button></div></form></div><div class="bg-white p-6 rounded-lg shadow-md"><div class="border-b"><nav class="-mb-px flex space-x-8"><button class="tab-button active" onclick="document.getElementById('monthly-summary').classList.remove('hidden'); document.getElementById('yearly-summary').classList.add('hidden'); this.classList.add('active'); this.nextElementSibling.classList.remove('active')">รายเดือน</button><button class="tab-button" onclick="document.getElementById('yearly-summary').classList.remove('hidden'); document.getElementById('monthly-summary').classList.add('hidden'); this.classList.add('active'); this.previousElementSibling.classList.remove('active')">ประวัติทั้งหมด</button></nav></div><div class="mt-4"><div id="monthly-summary"></div><div id="yearly-summary" class="hidden"></div></div></div></div>
    </div>

    <!-- Leave Calendar Section -->
    <div id="calendar-section" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">ปฏิทินวันลา</h1>
            <button id="back-to-app-btn-calendar" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">กลับหน้าหลัก</button>
        </header>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div id="calendar-header" class="flex justify-between items-center mb-4">
                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 text-2xl">&larr;</button>
                <h2 id="month-year-header" class="text-2xl font-bold"></h2>
                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 text-2xl">&rarr;</button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                <!-- Calendar will be populated by JS -->
            </div>
        </div>
    </div>


    <!-- Admin Report Section -->
    <div id="admin-report-section" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">รายงานสรุปภาพรวม</h1>
            <button id="back-to-app-btn-report" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">กลับหน้าหลัก</button>
        </header>
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex items-center gap-4 mb-4">
                <label for="admin-report-fiscal-year-selector" class="font-medium">เลือกปีงบประมาณ:</label>
                <select id="admin-report-fiscal-year-selector" class="p-2 border rounded-md"></select>
                <button id="generate-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">สร้างรายงาน</button>
            </div>
            <div id="report-results-container">
                <p class="text-center text-gray-500">กรุณาเลือกปีงบประมาณและกด "สร้างรายงาน" เพื่อดูข้อมูล</p>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Section -->
    <div id="admin-dashboard-section" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">แผงควบคุมผู้ดูแลระบบ</h1>
            <button id="back-to-app-btn" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">กลับหน้าหลัก</button>
        </header>

        <!-- Admin: User List View -->
        <div id="admin-dashboard-list-view">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">จัดการข้อมูลบุคลากร</h2>
            <div id="admin-user-list" class="space-y-4">
                <!-- User list will be populated here -->
            </div>
        </div>

        <!-- Admin: User Edit View -->
        <div id="admin-dashboard-edit-view" class="hidden">
            <div class="flex items-center gap-4 mb-6">
                <button id="back-to-list-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">&larr; กลับ</button>
                <h2 class="text-2xl font-semibold text-gray-700">แก้ไขข้อมูล: <span id="admin-edit-name" class="text-indigo-600"></span></h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Edit basic info -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">ข้อมูลทั่วไป</h3>
                    <form id="admin-edit-form" class="space-y-4">
                        <input type="hidden" id="admin-edit-staff-id">
                        <div>
                            <label for="admin-edit-staff-name" class="block text-sm font-medium text-gray-700">ชื่อ-สกุล</label>
                            <input type="text" id="admin-edit-staff-name" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="admin-edit-staff-type" class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                            <input type="text" id="admin-edit-staff-type" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">บันทึกข้อมูลทั่วไป</button>
                    </form>
                </div>
                <!-- Edit fiscal year data -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">จัดการวันลาพักผ่อนสะสม</h3>
                    <div id="admin-fiscal-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Fiscal year data will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Staff Management Modal -->
    <div id="staff-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-30">
        <div id="staff-modal-overlay" class="absolute inset-0"></div>
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white z-40">
            <div class="flex justify-between items-center pb-3 border-b"><h3 id="form-title" class="text-2xl font-medium">จัดการบุคลากร</h3><button id="close-modal-btn">X</button></div>
            <div class="mt-4">
                <form id="staff-form" class="bg-gray-50 p-4 rounded-lg mb-4 space-y-4">
                     <div><label for="staff-name">ชื่อ-สกุล</label><input type="text" id="staff-name" required class="mt-1 block w-full p-2 border rounded-md"></div>
                     <div><label for="staff-code">รหัสเจ้าหน้าที่</label><input type="text" id="staff-code" required class="mt-1 block w-full p-2 border rounded-md"></div>
                     <div><label for="staff-type">ตำแหน่ง</label><input type="text" id="staff-type" required class="mt-1 block w-full p-2 border rounded-md"></div>
                     <div class="flex items-center"><input type="checkbox" id="staff-is-admin" class="h-4 w-4 rounded"><label for="staff-is-admin" class="ml-2">เป็นผู้ดูแลระบบ (Admin)</label></div>
                     <button id="staff-submit-btn" type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">เพิ่มบุคลากร</button>
                </form>
                <h4 class="text-lg font-medium mb-2">รายชื่อบุคลากรทั้งหมด</h4>
                <div id="staff-list" class="max-h-60 overflow-y-auto space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Edit Leave Modal -->
    <div id="edit-leave-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-30">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white z-40">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-2xl font-medium">แก้ไขข้อมูลการลา</h3>
                <button id="close-edit-leave-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="mt-4">
                <form id="edit-leave-form" class="space-y-4">
                    <input type="hidden" id="edit-leave-id">
                    <div>
                        <label for="edit-leave-type">ประเภท</label>
                        <select id="edit-leave-type" required class="mt-1 block w-full p-2 border rounded-md">
                            <option value="vacation">พักผ่อน</option>
                            <option value="personal">กิจ</option>
                            <option value="sick">ป่วย</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-start-date">วันที่เริ่ม</label>
                            <input type="date" id="edit-start-date" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="edit-end-date">วันที่สิ้นสุด</label>
                            <input type="date" id="edit-end-date" required class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div>
                        <label for="edit-days-taken">จำนวนวัน</label>
                        <input type="number" step="0.5" id="edit-days-taken" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="edit-reason">เหตุผล</label>
                        <input type="text" id="edit-reason" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">บันทึกการเปลี่ยนแปลง</button>
                </form>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm py-8 mt-8">
        <hr class="mb-4">
        <p>พัฒนาโดย ทพ.สุทธิเกียรติ ยอดภักดี</p>
    </footer>
</body>
</html>

